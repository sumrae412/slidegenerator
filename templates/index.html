<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent AI Code Collaboration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .typing-indicator {
            display: inline-block;
        }
        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">ü§ñ Multi-Agent AI Code Collaboration</h1>
                    <p class="text-sm text-gray-600">Claude + ChatGPT ‚Üí Reliable Project Generation</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">Connecting...</span>
                    </div>
                    <button id="status-btn" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                        Status
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Input Section -->
        <div class="bg-white rounded-lg shadow-sm border mb-8">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">üí≠ Describe Your Coding Project</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Project Description</label>
                        <textarea
                            id="prompt"
                            rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Example: Create a web scraper that extracts product information from e-commerce sites, handles rate limiting, and saves data to both CSV and JSON formats with error handling and logging."
                        ></textarea>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="project-name" class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                            <input
                                type="text"
                                id="project-name"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="my_awesome_project"
                            />
                        </div>
                        
                        <div>
                            <label for="max-iterations" class="block text-sm font-medium text-gray-700 mb-2">Max Refinements</label>
                            <select id="max-iterations" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">1 iteration</option>
                                <option value="2" selected>2 iterations</option>
                                <option value="3">3 iterations</option>
                            </select>
                        </div>
                        
                        <button
                            id="generate-btn"
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-medium"
                        >
                            üöÄ Generate Complete Project
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="bg-white rounded-lg shadow-sm border mb-8 hidden">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‚ö° Workflow Progress</h3>
                    <span id="progress-text" class="text-sm text-gray-600">Stage 0/7</span>
                </div>
                
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                    <div id="progress-bar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                
                <div id="current-activity" class="text-sm text-gray-600 flex items-center">
                    <div class="typing-indicator mr-2"></div>
                    <span>Initializing workflow...</span>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div id="activity-log" class="bg-white rounded-lg shadow-sm border mb-8">
            <div class="border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-900">üì∫ Live Activity Log</h3>
            </div>
            <div class="p-6">
                <div id="log-messages" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-sm text-gray-500 text-center py-4">
                        Ready to start your AI collaboration project...
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="border-b border-gray-200 px-6 py-4">
                    <h3 class="text-lg font-semibold text-gray-900">üéâ Project Generated Successfully!</h3>
                </div>
                <div class="p-6">
                    <div id="project-content"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Status Modal -->
    <div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üîß System Status</h3>
            <div id="status-content" class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Claude API</span>
                    <span id="claude-status" class="text-sm">Checking...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">ChatGPT API</span>
                    <span id="chatgpt-status" class="text-sm">Checking...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">WebSocket</span>
                    <span id="websocket-status" class="text-sm">Checking...</span>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="close-status" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        class MultiAgentApp {
            constructor() {
                this.socket = null;
                this.results = [];
                this.projectFiles = [];
                this.init();
            }
            
            init() {
                this.setupSocket();
                this.setupEventListeners();
                this.checkStatus();
            }
            
            setupSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.updateConnectionStatus('connected');
                    this.addLogMessage('Socket.IO connected successfully', 'system');
                });
                
                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus('disconnected');
                    this.addLogMessage('Socket.IO connection closed', 'system');
                });
                
                this.socket.on('connect_error', () => {
                    this.updateConnectionStatus('error');
                    this.addLogMessage('Socket.IO connection error occurred', 'system');
                });
                
                // Workflow event handlers
                this.socket.on('progress', (data) => {
                    this.updateProgress(data.stage, data.message);
                    this.addLogMessage(`${data.agent}: ${data.message}`, 'info');
                });
                
                this.socket.on('stage_start', (data) => {
                    this.updateProgress(data.stage, data.message);
                    this.addLogMessage(`Starting Stage ${data.stage}/${data.total_stages}: ${data.message}`, 'info');
                });
                
                this.socket.on('stage_complete', (data) => {
                    this.addLogMessage(`‚úÖ Stage ${data.stage} completed: ${data.message}`, 'success');
                });
                
                this.socket.on('workflow_complete', (data) => {
                    this.handleWorkflowComplete(data);
                });
                
                this.socket.on('error', (data) => {
                    this.addLogMessage(`‚ùå Error: ${data.message}`, 'error');
                    this.hideProgress();
                });
            }
            
            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connection-status');
                const indicator = statusEl.querySelector('div');
                const text = statusEl.querySelector('span');
                
                switch(status) {
                    case 'connected':
                        indicator.className = 'w-2 h-2 bg-green-500 rounded-full';
                        text.textContent = 'Connected';
                        break;
                    case 'disconnected':
                        indicator.className = 'w-2 h-2 bg-red-500 rounded-full';
                        text.textContent = 'Disconnected';
                        break;
                    case 'error':
                        indicator.className = 'w-2 h-2 bg-red-500 rounded-full animate-pulse';
                        text.textContent = 'Error';
                        break;
                    default:
                        indicator.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                        text.textContent = 'Connecting...';
                }
            }
            
            
            updateProgress(stage, message) {
                const progressSection = document.getElementById('progress-section');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const currentActivity = document.getElementById('current-activity').querySelector('span');
                
                progressSection.classList.remove('hidden');
                
                const progress = (stage / 7) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Stage ${stage}/7`;
                currentActivity.textContent = message;
            }
            
            hideProgress() {
                document.getElementById('progress-section').classList.add('hidden');
            }
            
            handleWorkflowComplete(message) {
                this.results = message.results;
                this.projectFiles = message.project_files;
                
                this.hideProgress();
                this.showResults();
                this.addLogMessage('üéâ Workflow completed successfully!', 'success');
            }
            
            showResults() {
                const resultsSection = document.getElementById('results-section');
                const projectContent = document.getElementById('project-content');
                
                let content = '<div class="space-y-6">';
                
                // Summary
                content += `<div class="grid grid-cols-3 gap-4 mb-6">`;
                content += `<div class="bg-blue-50 rounded-lg p-4 text-center"><div class="text-2xl font-bold text-blue-600">${this.results.length}</div><div class="text-sm text-gray-600">Workflow Stages</div></div>`;
                content += `<div class="bg-green-50 rounded-lg p-4 text-center"><div class="text-2xl font-bold text-green-600">${this.projectFiles.length}</div><div class="text-sm text-gray-600">Files Generated</div></div>`;
                content += `<div class="bg-purple-50 rounded-lg p-4 text-center"><div class="text-2xl font-bold text-purple-600">2</div><div class="text-sm text-gray-600">AI Agents</div></div>`;
                content += `</div>`;
                
                // Files
                if (this.projectFiles.length > 0) {
                    content += `<h4 class="text-lg font-semibold text-gray-900 mb-4">üì¶ Generated Files</h4>`;
                    content += `<div class="grid grid-cols-1 gap-4">`;
                    
                    this.projectFiles.forEach((file, index) => {
                        content += `<div class="border border-gray-200 rounded-lg">`;
                        content += `<div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">`;
                        content += `<div><h5 class="font-semibold text-gray-900">üìÑ ${file.filename}</h5><p class="text-sm text-gray-600">${file.description}</p></div>`;
                        content += `<button class="download-btn px-3 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-md transition-colors" data-filename="${file.filename}" data-content="${this.escapeHtml(file.content)}">Download</button>`;
                        content += `</div>`;
                        content += `<div class="p-4">`;
                        
                        if (file.filename.endsWith('.py')) {
                            content += `<pre><code class="language-python">${this.escapeHtml(file.content)}</code></pre>`;
                        } else if (file.filename.endsWith('.md')) {
                            content += `<div class="prose max-w-none">${this.formatMarkdown(file.content)}</div>`;
                        } else {
                            content += `<pre class="text-sm text-gray-700 whitespace-pre-wrap">${this.escapeHtml(file.content)}</pre>`;
                        }
                        
                        content += `</div></div>`;
                    });
                    
                    content += `</div>`;
                    
                    // Download all button
                    content += `<div class="mt-6 text-center">`;
                    content += `<button id="download-all-btn" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">üì¶ Download Complete Project</button>`;
                    content += `</div>`;
                }
                
                content += '</div>';
                
                projectContent.innerHTML = content;
                resultsSection.classList.remove('hidden');
                
                // Add download functionality
                this.setupDownloads();
                
                // Syntax highlighting
                setTimeout(() => {
                    if (window.Prism) {
                        Prism.highlightAll();
                    }
                }, 100);
                
                // Scroll to results
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            setupDownloads() {
                // Individual file downloads
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const filename = e.target.dataset.filename;
                        const content = e.target.dataset.content;
                        this.downloadFile(filename, content);
                    });
                });
                
                // Download all files
                document.getElementById('download-all-btn')?.addEventListener('click', () => {
                    this.projectFiles.forEach(file => {
                        setTimeout(() => {
                            this.downloadFile(file.filename, file.content);
                        }, 100);
                    });
                });
            }
            
            setupEventListeners() {
                // Generate button
                document.getElementById('generate-btn').addEventListener('click', () => {
                    this.startGeneration();
                });
                
                // Status button
                document.getElementById('status-btn').addEventListener('click', () => {
                    this.showStatusModal();
                });
                
                // Status modal close
                document.getElementById('close-status').addEventListener('click', () => {
                    this.hideStatusModal();
                });
            }
            
            startGeneration() {
                const prompt = document.getElementById('prompt').value.trim();
                const projectName = document.getElementById('project-name').value.trim();
                const maxIterations = parseInt(document.getElementById('max-iterations').value);
                
                if (!prompt) {
                    alert('Please enter a project description');
                    return;
                }
                
                if (!projectName) {
                    alert('Please enter a project name');
                    return;
                }
                
                // Reset state
                this.results = [];
                this.projectFiles = [];
                
                // Hide previous results
                document.getElementById('results-section').classList.add('hidden');
                
                // Clear log
                document.getElementById('log-messages').innerHTML = '';
                
                // Start workflow
                if (this.socket && this.socket.connected) {
                    this.socket.emit('generate', {
                        prompt: prompt,
                        project_name: projectName,
                        max_iterations: maxIterations
                    });
                    
                    this.addLogMessage('üöÄ Starting project generation workflow...', 'info');
                } else {
                    this.addLogMessage('‚ùå Socket not connected. Please refresh the page.', 'error');
                }
            }
            
            async checkStatus() {
                try {
                    const response = await fetch('/api/status');
                    const status = await response.json();
                    
                    document.getElementById('claude-status').textContent = status.claude;
                    document.getElementById('chatgpt-status').textContent = status.chatgpt;
                    document.getElementById('websocket-status').textContent = 
                        this.socket && this.socket.connected ? '‚úÖ Connected' : '‚ùå Disconnected';
                } catch (error) {
                    console.error('Failed to check status:', error);
                }
            }
            
            showStatusModal() {
                this.checkStatus();
                document.getElementById('status-modal').classList.remove('hidden');
                document.getElementById('status-modal').classList.add('flex');
            }
            
            hideStatusModal() {
                document.getElementById('status-modal').classList.add('hidden');
                document.getElementById('status-modal').classList.remove('flex');
            }
            
            addLogMessage(message, type = 'info') {
                const logMessages = document.getElementById('log-messages');
                const messageEl = document.createElement('div');
                
                const timestamp = new Date().toLocaleTimeString();
                let iconClass, textClass;
                
                switch(type) {
                    case 'success':
                        iconClass = 'text-green-600';
                        textClass = 'text-green-800';
                        break;
                    case 'error':
                        iconClass = 'text-red-600';
                        textClass = 'text-red-800';
                        break;
                    case 'info':
                        iconClass = 'text-blue-600';
                        textClass = 'text-blue-800';
                        break;
                    default:
                        iconClass = 'text-gray-600';
                        textClass = 'text-gray-800';
                }
                
                messageEl.className = `flex items-start space-x-2 text-sm fade-in`;
                messageEl.innerHTML = `
                    <span class="text-xs text-gray-400 flex-shrink-0 w-16">${timestamp}</span>
                    <span class="${iconClass} flex-shrink-0">‚Ä¢</span>
                    <span class="${textClass} flex-grow">${message}</span>
                `;
                
                logMessages.appendChild(messageEl);
                logMessages.scrollTop = logMessages.scrollHeight;
            }
            
            formatMarkdown(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>')
                    .replace(/^#{1,6}\s+(.*$)/gm, (match, p1) => {
                        const level = match.match(/^#+/)[0].length;
                        return `<h${level} class="text-lg font-semibold text-gray-900 mb-2 mt-4">${p1}</h${level}>`;
                    })
                    .split('\n').join('<br>');
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            downloadFile(filename, content) {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new MultiAgentApp();
        });
    </script>
</body>
</html>