<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Google Docs to Slides Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .step-card {
            transition: all 0.3s ease;
        }
        .step-card.completed {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }
        .step-card.active {
            background-color: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold">üîß Setup Google Docs to Slides</h1>
                    <p class="opacity-90">Configure your Google API credentials to get started</p>
                </div>
                <a href="/" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-colors">
                    ‚Üê Back to App
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Setup Status -->
        <div class="mb-8">
            <div id="setup-status" class="bg-white rounded-lg border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Setup Status</h2>
                        <p id="status-message" class="text-gray-600">Checking configuration...</p>
                    </div>
                    <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-300"></div>
                </div>
            </div>
        </div>

        <!-- Step 1: Google Cloud Setup -->
        <div class="step-card bg-white rounded-lg border-2 border-gray-200 p-6 mb-6">
            <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-semibold mr-4">1</div>
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Create Google Cloud Project & Enable APIs</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 mb-2">Quick Setup Steps:</h4>
                            <ol class="list-decimal list-inside text-blue-800 space-y-1 text-sm">
                                <li>Go to <a href="https://console.cloud.google.com/" target="_blank" class="underline hover:text-blue-600">Google Cloud Console</a></li>
                                <li>Create a new project (e.g., "docs-to-slides-app")</li>
                                <li>Enable these APIs in "APIs & Services" ‚Üí "Library":
                                    <ul class="list-disc list-inside ml-4 mt-1">
                                        <li><strong>Google Docs API</strong></li>
                                        <li><strong>Google Drive API</strong></li>
                                        <li>Google Slides API (optional)</li>
                                    </ul>
                                </li>
                                <li>Go to "APIs & Services" ‚Üí "Credentials"</li>
                                <li>Click "Create Credentials" ‚Üí "OAuth 2.0 Client IDs"</li>
                                <li>Configure OAuth consent screen if prompted</li>
                                <li>Choose "Web application" as application type</li>
                                <li>Add authorized redirect URIs:
                                    <ul class="list-disc list-inside ml-4 mt-1 font-mono text-xs">
                                        <li>http://localhost:5000/callback</li>
                                        <li>http://127.0.0.1:5000/callback</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                        
                        <div class="flex space-x-3">
                            <a href="https://console.cloud.google.com/" target="_blank" 
                               class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                üîó Open Google Cloud Console
                            </a>
                            <a href="/download-template" 
                               class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                üìÑ Download Template
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Upload Credentials -->
        <div class="step-card bg-white rounded-lg border-2 border-gray-200 p-6 mb-6">
            <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-semibold mr-4">2</div>
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Upload Your Credentials File</h3>
                    
                    <div class="space-y-4">
                        <p class="text-gray-600">
                            After creating your OAuth credentials, download the JSON file and upload it here.
                            The file is usually named something like <code class="bg-gray-100 px-1 rounded">client_secret_xxx.json</code>.
                        </p>
                        
                        <!-- File Upload Area -->
                        <div id="upload-area" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                            <div id="upload-content">
                                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <p class="text-gray-600 mb-2">
                                    <span class="font-medium">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-sm text-gray-500">JSON files only</p>
                            </div>
                            <input type="file" id="credentials-file" class="hidden" accept=".json" />
                        </div>
                        
                        <!-- Upload Status -->
                        <div id="upload-status" class="hidden"></div>
                        
                        <!-- Manual Entry Option -->
                        <details class="border rounded-lg p-4">
                            <summary class="cursor-pointer font-medium text-gray-700 hover:text-gray-900">
                                üìù Or enter credentials manually
                            </summary>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Client ID</label>
                                    <input type="text" id="manual-client-id" placeholder="xxx.apps.googleusercontent.com" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Client Secret</label>
                                    <input type="password" id="manual-client-secret" placeholder="Your client secret" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Project ID (optional)</label>
                                    <input type="text" id="manual-project-id" placeholder="your-project-id" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="save-manual-credentials" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    üíæ Save Credentials
                                </button>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Test Connection -->
        <div class="step-card bg-white rounded-lg border-2 border-gray-200 p-6 mb-6">
            <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-semibold mr-4">3</div>
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Test Your Setup</h3>
                    <p class="text-gray-600 mb-4">
                        Once your credentials are uploaded, test the Google authentication to make sure everything works.
                    </p>
                    
                    <div class="space-x-3">
                        <button id="test-auth" disabled
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                            üîê Test Google Authentication
                        </button>
                        <a href="/" 
                           class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors inline-block">
                            üöÄ Go to App
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-yellow-800 mb-3">üîß Troubleshooting</h3>
            <div class="space-y-2 text-yellow-700 text-sm">
                <p><strong>‚Ä¢ "Redirect URI mismatch":</strong> Make sure you added both redirect URIs in Google Cloud Console</p>
                <p><strong>‚Ä¢ "Invalid credentials format":</strong> Download the file again from Google Cloud Console</p>
                <p><strong>‚Ä¢ "App not verified":</strong> Click "Advanced" ‚Üí "Go to [your app] (unsafe)" during testing</p>
                <p><strong>‚Ä¢ "API not enabled":</strong> Enable Google Docs API and Google Drive API in your project</p>
            </div>
        </div>
    </main>

    <script>
        let setupStatus = {
            credentials_valid: false,
            setup_complete: false
        };

        // Check setup status on page load
        async function checkSetupStatus() {
            try {
                const response = await fetch('/api/setup-status');
                setupStatus = await response.json();
                updateSetupStatus();
                updateStepStates();
            } catch (error) {
                console.error('Error checking setup status:', error);
            }
        }

        function updateSetupStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusMessage = document.getElementById('status-message');
            
            if (setupStatus.setup_complete) {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500';
                statusMessage.textContent = 'Setup complete! Ready to convert documents.';
            } else {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500';
                statusMessage.textContent = 'Setup required. Please complete the steps below.';
            }
        }

        function updateStepStates() {
            const steps = document.querySelectorAll('.step-card');
            
            // Step 2 (upload) - mark as active if credentials not valid
            if (!setupStatus.credentials_valid) {
                steps[1].classList.add('active');
            } else {
                steps[1].classList.add('completed');
                steps[1].classList.remove('active');
                document.getElementById('test-auth').disabled = false;
            }
            
            // Step 3 (test) - mark as active if credentials valid but not tested
            if (setupStatus.credentials_valid) {
                steps[2].classList.add('active');
            }
        }

        // File upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('credentials-file');
        const uploadStatus = document.getElementById('upload-status');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            if (!file.name.endsWith('.json')) {
                showUploadStatus('error', 'Please select a JSON file');
                return;
            }

            showUploadStatus('loading', 'Validating credentials...');

            const formData = new FormData();
            formData.append('credentials', file);

            try {
                const response = await fetch('/api/validate-credentials', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showUploadStatus('success', `‚úÖ Credentials uploaded successfully! Client ID: ${result.client_id}`);
                    setupStatus.credentials_valid = true;
                    updateSetupStatus();
                    updateStepStates();
                } else {
                    showUploadStatus('error', result.error);
                }
            } catch (error) {
                showUploadStatus('error', 'Error uploading file: ' + error.message);
            }
        }

        function showUploadStatus(type, message) {
            const statusEl = uploadStatus;
            statusEl.className = 'p-4 rounded-lg ' + (
                type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' :
                type === 'error' ? 'bg-red-50 border border-red-200 text-red-700' :
                'bg-blue-50 border border-blue-200 text-blue-700'
            );
            
            if (type === 'loading') {
                statusEl.innerHTML = `<div class="flex items-center"><div class="spinner mr-3"></div>${message}</div>`;
            } else {
                statusEl.textContent = message;
            }
            
            statusEl.classList.remove('hidden');
        }

        // Manual credentials entry
        document.getElementById('save-manual-credentials').addEventListener('click', async () => {
            const clientId = document.getElementById('manual-client-id').value;
            const clientSecret = document.getElementById('manual-client-secret').value;
            const projectId = document.getElementById('manual-project-id').value;

            if (!clientId || !clientSecret) {
                alert('Please enter both Client ID and Client Secret');
                return;
            }

            const credentials = {
                web: {
                    client_id: clientId,
                    client_secret: clientSecret,
                    project_id: projectId || 'manual-entry',
                    auth_uri: 'https://accounts.google.com/o/oauth2/auth',
                    token_uri: 'https://oauth2.googleapis.com/token',
                    auth_provider_x509_cert_url: 'https://www.googleapis.com/oauth2/v1/certs',
                    redirect_uris: [
                        'http://localhost:5000/callback',
                        'http://127.0.0.1:5000/callback'
                    ]
                }
            };

            const blob = new Blob([JSON.stringify(credentials, null, 2)], { type: 'application/json' });
            const file = new File([blob], 'credentials.json', { type: 'application/json' });
            
            await handleFileUpload(file);
        });

        // Test authentication
        document.getElementById('test-auth').addEventListener('click', () => {
            window.open('/auth', '_blank');
        });

        // Initialize
        checkSetupStatus();
    </script>
</body>
</html>